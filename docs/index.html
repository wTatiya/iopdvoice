<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>แดชบอร์ดความพึงพอใจเสียงผู้ป่วยนอก–ใน</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Inter", "Segoe UI", sans-serif;
        line-height: 1.6;
        background: #ffffff;
        color: #111827;
      }

      body {
        margin: 0;
        padding: 0;
        background: #ffffff;
      }

      header {
        padding: 3rem 5vw 2rem;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      header h1 {
        margin: 0 0 0.5rem;
        font-size: clamp(2rem, 3vw, 3.2rem);
        color: #0f172a;
      }

      header p {
        max-width: 70ch;
        margin: 0;
        color: #1f2937;
      }

      main {
        padding: 2rem 5vw 4rem;
        display: flex;
        flex-direction: column;
        gap: 2.5rem;
      }

      section {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 20px 45px rgba(15, 23, 42, 0.08);
      }

      h2 {
        margin-top: 0;
        font-size: clamp(1.5rem, 2.2vw, 2.4rem);
        color: #0f172a;
      }

      h3 {
        margin-top: 1.5rem;
        font-size: clamp(1.2rem, 1.8vw, 1.8rem);
        color: #0f172a;
      }

      .metric-grid {
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      .metric-card,
      .chart-card,
      .list-card,
      .insight-card {
        background: #f8fafc;
        border-radius: 16px;
        padding: 1.5rem;
        border: 1px solid #dbeafe;
      }

      .metric-card h4 {
        margin: 0;
        font-size: 0.95rem;
        color: #1f2937;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }

      .metric-card p {
        margin: 0.75rem 0 0;
        font-size: clamp(1.8rem, 3vw, 2.6rem);
        font-weight: 600;
        color: #0f172a;
      }

      .chart-container {
        width: 100%;
        min-height: 360px;
      }

      .split-grid {
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }

      .list-card ul {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 1rem;
      }

      .list-card li {
        display: grid;
        gap: 0.35rem;
      }

      .list-card strong {
        color: #0f172a;
      }

      .tag {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.2rem 0.65rem;
        border-radius: 999px;
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        background: #e0f2fe;
        color: #0f172a;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1.5rem;
        font-size: 0.95rem;
        background: #ffffff;
        border-radius: 16px;
        overflow: hidden;
      }

      th,
      td {
        padding: 0.75rem 1rem;
        text-align: left;
      }

      th {
        background: #e0f2fe;
        color: #0f172a;
        font-weight: 600;
        letter-spacing: 0.03em;
        text-transform: uppercase;
        font-size: 0.78rem;
      }

      tbody tr:nth-child(even) {
        background: #f8fafc;
      }

      tbody tr:hover {
        background: #e0f2fe;
      }

      .tab-strip {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-top: 1rem;
      }

      .tab-strip button {
        border: 1px solid #bae6fd;
        background: #ffffff;
        color: #0f172a;
        padding: 0.5rem 1.25rem;
        border-radius: 999px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.95rem;
      }

      .tab-strip button.active {
        background: #bae6fd;
        color: #0f172a;
        border-color: #0ea5e9;
        box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.25);
      }

      .tab-strip button:hover {
        background: #dbeafe;
      }

      ul.insights {
        list-style: none;
        padding-left: 1.2rem;
        display: grid;
        gap: 0.75rem;
      }

      ul.insights li::before {
        content: "▹";
        margin-right: 0.5rem;
        color: #0f172a;
      }

      .control-group {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
      }

      .control-group label {
        font-size: 0.95rem;
        color: #1f2937;
      }

      .control-group select {
        background: #ffffff;
        color: #0f172a;
        border: 1px solid #bae6fd;
        border-radius: 999px;
        padding: 0.4rem 1rem;
        font-size: 0.95rem;
      }

      .inline-stats {
        display: flex;
        flex-wrap: wrap;
        gap: 1.25rem;
        margin-top: 1rem;
        color: #1f2937;
        font-size: 0.95rem;
      }

      .inline-stats span {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .note {
        font-size: 0.85rem;
        color: #4b5563;
        margin-top: 1rem;
      }

      footer {
        text-align: center;
        font-size: 0.85rem;
        color: #4b5563;
        padding: 2rem 5vw 3rem;
      }

      .table-scroll {
        overflow-x: auto;
      }

      .highlight-value {
        font-weight: 600;
        color: #0f172a;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.2rem 0.75rem;
        border-radius: 999px;
        background: #dbeafe;
        color: #0f172a;
        font-size: 0.8rem;
      }

      .legend {
        display: flex;
        flex-wrap: wrap;
        gap: 0.65rem;
        margin-top: 0.75rem;
      }

      .legend span {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.85rem;
        color: #1f2937;
      }

      .legend span::before {
        content: "";
        width: 12px;
        height: 12px;
        border-radius: 3px;
        display: inline-block;
      }

      @media (max-width: 720px) {
        header,
        main,
        footer {
          padding-left: 1.25rem;
          padding-right: 1.25rem;
        }

        section {
          padding: 1.5rem;
        }

        table {
          font-size: 0.85rem;
        }

        th,
        td {
          padding: 0.65rem 0.75rem;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>แดชบอร์ดความพึงพอใจเสียงผู้ป่วยนอก–ใน</h1>
      <p>
        มุมมองภาพรวมของแบบสำรวจความพึงพอใจผู้ป่วยนอกและผู้ป่วยในตั้งแต่ตุลาคม 2024 ถึงสิงหาคม 2025 สำรวจคะแนนความพึงพอใจรายเดือน ความผันผวนในการให้บริการ หัวข้อความรู้สึกของผู้ป่วย และสัญญาณความเสี่ยงเชิงคาดการณ์ที่สกัดจากความคิดเห็นเชิงบรรยายมากกว่า 4,000 รายการ
      </p>
    </header>
    <main>
      <section id="at-a-glance">
        <h2>ภาพรวมฉับไว</h2>
        <div class="metric-grid" id="metrics"></div>
        <h3>ความครอบคลุมของแบบสำรวจ</h3>
        <p id="coverage"></p>
        <div class="table-scroll">
          <table id="monthly-table" aria-label="หน่วยงานที่ทำคะแนนสูงสุดและต่ำสุดรายเดือน">
            <thead>
              <tr>
                <th scope="col">เดือน</th>
                <th scope="col">หน่วยงานที่ได้คะแนนสูงสุด</th>
                <th scope="col">คะแนน</th>
                <th scope="col">หน่วยงานที่ได้คะแนนต่ำสุด</th>
                <th scope="col">คะแนน</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="service-dynamics">
        <h2>พลวัตคุณภาพการบริการ</h2>
        <p>
          ติดตามพื้นที่ที่คุณภาพการบริการผันผวน และค้นหาหน่วยงานที่ทำให้ผู้ป่วยประทับใจอย่างสม่ำเสมอโดยคำนึงถึงน้ำหนักตามจำนวนแบบฟอร์มสำรวจที่ได้รับ
        </p>
        <div class="split-grid">
          <div class="chart-card">
            <h3>ดัชนีความผันผวน (σ ของคะแนนรายเดือน)</h3>
            <div class="chart-container" id="volatility-chart" role="img" aria-label="ดัชนีความผันผวนของแต่ละหน่วยงาน"></div>
            <div class="inline-stats" id="volatility-summary"></div>
          </div>
          <div class="list-card">
            <h3>หน่วยงานตัวอย่างมาตรฐานสูง</h3>
            <p class="note">
              แสดงค่าเฉลี่ยแบบถ่วงน้ำหนัก หน่วยงานต้องมีข้อมูลต่อเนื่องอย่างน้อย 6 เดือนพร้อมคะแนนเฉลี่ย ≥4.60
            </p>
            <ul id="high-performance-list"></ul>
          </div>
          <div class="list-card">
            <h3>ช่องว่างการบริการที่ต้องเร่งด่วน</h3>
            <p class="note">
              หน่วยงานที่ทำคะแนนแบบถ่วงน้ำหนักต่ำที่สุดโดยมีจำนวนแบบฟอร์มกำกับ ใช้ค่าความผันผวนเพื่อจัดลำดับการแก้ไขเร่งด่วน
            </p>
            <ul id="critical-gaps-list"></ul>
          </div>
        </div>
      </section>

      <section id="trend-analysis">
        <h2>วิเคราะห์แนวโน้มรายหน่วยงาน</h2>
        <p>
          ดูภาพรวมความพึงพอใจต่อเนื่องรายเดือนของแต่ละหน่วยงาน วางเมาส์เพื่อดูค่าเฉลี่ยแบบถ่วงน้ำหนักและจำนวนแบบสำรวจที่รายงาน
        </p>
        <div class="control-group">
          <label for="trend-select">เลือกหน่วยงาน</label>
          <select id="trend-select" aria-label="เลือกหน่วยงานสำหรับกราฟแนวโน้ม"></select>
          <span class="pill" id="trend-months"></span>
        </div>
        <div class="chart-card" style="padding: 1.25rem">
          <div class="chart-container" id="trend-chart" role="img" aria-label="แนวโน้มความพึงพอใจรายเดือน"></div>
          <div class="inline-stats" id="trend-stats"></div>
        </div>
      </section>

      <section id="rankings">
        <h2>การจัดอันดับหน่วยงาน</h2>
        <p>
          การจัดอันดับคำนวณโดยถ่วงน้ำหนักตามจำนวนแบบสำรวจที่มีการรายงาน สลับมุมมองเพื่อดูหน่วยงานที่แข็งแกร่งและอ่อนที่สุดโดยรวม หรือเฉพาะแต่ละปีปฏิทิน
        </p>
        <div class="tab-strip" role="tablist" aria-label="มุมมองการจัดอันดับ">
          <button type="button" data-key="overall" class="active">ภาพรวม</button>
          <button type="button" data-key="2024">ปี 2024</button>
          <button type="button" data-key="2025">ปี 2025</button>
        </div>
        <div class="metric-grid" style="margin-top: 1.5rem">
          <div>
            <h3>10 หน่วยงานอันดับสูงสุด</h3>
            <div class="table-scroll">
              <table id="top-table" aria-live="polite">
                <thead>
                  <tr>
                    <th scope="col">อันดับ</th>
                    <th scope="col">หน่วยงาน</th>
                    <th scope="col">คะแนนเฉลี่ย</th>
                    <th scope="col">จำนวนแบบสำรวจ</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div>
            <h3>หน่วยงานที่ได้คะแนนต่ำสุด</h3>
            <div class="table-scroll">
              <table id="bottom-table" aria-live="polite">
                <thead>
                  <tr>
                    <th scope="col">อันดับ</th>
                    <th scope="col">หน่วยงาน</th>
                    <th scope="col">คะแนนเฉลี่ย</th>
                    <th scope="col">จำนวนแบบสำรวจ</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section id="sentiment-insights">
        <h2>ภาพรวมความรู้สึกและประเด็นสำคัญ</h2>
        <p>
          การวิเคราะห์ข้อความของสรุปความคิดเห็นภาษาไทยรายเดือนเผยให้เห็นประเด็นปัญหาและความประทับใจที่พบบ่อยที่สุด ใช้กราฟแบบซ้อนเพื่อดูการเปลี่ยนแปลงของหัวข้อเมื่อเวลาผ่านไป
        </p>
        <div class="chart-card">
          <h3>ความถี่ของหัวข้อเมื่อเทียบกับเวลา</h3>
          <div class="chart-container" id="theme-chart" role="img" aria-label="จำนวนหัวข้อแบบซ้อนรายเดือน"></div>
          <div class="legend" id="theme-legend"></div>
        </div>
        <div class="split-grid">
          <div class="insight-card">
            <h3>จุดอ่อนเชิงระบบ</h3>
            <ul class="insights" id="systemic-weaknesses"></ul>
            <p class="note" id="sentiment-summary"></p>
          </div>
          <div class="insight-card">
            <h3>สัญญาณช่วงเวลาและกลุ่มผู้รับบริการ</h3>
            <table>
              <thead>
                <tr>
                  <th scope="col">ช่วงเวลาปฏิบัติงาน</th>
                  <th scope="col">จำนวนการกล่าวถึง</th>
                  <th scope="col">สัดส่วน</th>
                </tr>
              </thead>
              <tbody id="time-table"></tbody>
            </table>
            <table style="margin-top: 1rem">
              <thead>
                <tr>
                  <th scope="col">สัญญาณเชิงประชากร</th>
                  <th scope="col">จำนวนการกล่าวถึง</th>
                </tr>
              </thead>
              <tbody id="demographic-mentions"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="operations">
        <h2>ความสัมพันธ์ด้านปฏิบัติการและการเปรียบเทียบ</h2>
        <div class="split-grid">
          <div class="chart-card">
            <h3>สัญญาณเวลารอเทียบกับความพึงพอใจ</h3>
            <div class="chart-container" id="wait-correlation-chart" role="img" aria-label="กราฟกระจายความถี่หัวข้อเวลารอกับความพึงพอใจ"></div>
            <p class="note" id="wait-correlation-note"></p>
          </div>
          <div class="insight-card">
            <h3>เปรียบเทียบโครงสร้างกลุ่มบนและกลุ่มล่าง</h3>
            <ul class="insights" id="benchmarking-list"></ul>
            <p class="note">
              ค่าเฉลี่ยแบบถ่วงน้ำหนักใช้จำนวนแบบฟอร์มที่รายงาน หน่วยงานที่ไม่มีการรายงานจำนวนจะใช้ค่าเฉลี่ยธรรมดา
            </p>
          </div>
        </div>
      </section>

      <section id="predictive-risk">
        <h2>มุมมองความเสี่ยงเชิงคาดการณ์</h2>
        <p>
          แบบจำลองลอจิสติกใช้คะแนนย้อนหลังสามเดือนของแต่ละหน่วยงานเพื่อระบุพื้นที่ที่มีแนวโน้มลดลงในรอบรายงานถัดไป ความน่าจะเป็นที่สูงขึ้นหมายถึงความเสี่ยงที่จะลดลงอย่างน้อย 0.05 คะแนนเมื่อเทียบกับเดือนล่าสุด
        </p>
        <div class="table-scroll">
          <table id="risk-table">
            <thead>
              <tr>
                <th scope="col">หน่วยงาน</th>
                <th scope="col">ความน่าจะเป็นของคะแนนลดลง</th>
                <th scope="col">เดือนล่าสุดที่พบ</th>
                <th scope="col">คะแนนล่าสุด</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="equity">
        <h2>ตรวจสอบความแตกต่างระหว่างกลุ่มผู้รับบริการ</h2>
        <p>
          หน่วยงานถูกจัดกลุ่มตามบริการระดับสูงเพื่อเปรียบเทียบคะแนนความพึงพอใจเฉลี่ยและความครอบคลุมของแบบสำรวจ การสแกนคำสำคัญช่วยระบุว่ากลุ่มใดถูกกล่าวถึงมากที่สุดในข้อเสนอแนะปลายเปิด
        </p>
        <div class="split-grid">
          <div class="table-scroll">
            <table id="service-group-table">
              <thead>
                <tr>
                  <th scope="col">กลุ่มบริการ</th>
                  <th scope="col">คะแนนเฉลี่ย</th>
                  <th scope="col">จำนวนแบบฟอร์มที่รายงาน</th>
                  <th scope="col">จำนวนหน่วยงาน</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="table-scroll">
            <table id="demographic-table">
              <thead>
                <tr>
                  <th scope="col">กลุ่มที่ถูกกล่าวถึง</th>
                  <th scope="col">จำนวนความคิดเห็น</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="methodology">
        <h2>ระเบียบวิธี</h2>
        <p>
          ข้อมูลถูกแยกจากแผ่นงาน <code>Total Table</code> ในไฟล์ Excel รายเดือนโดยตรง ค่าเฉลี่ยแบบถ่วงน้ำหนักใช้จำนวนแบบสำรวจที่รายงาน หากไม่มีจำนวนจะใช้ค่าเฉลี่ยของคะแนนที่บันทึกไว้ หัวข้อความเห็นได้จากสรุปคำบรรยายภาษาไทยโดยใช้พจนานุกรมคำสำคัญที่สอดคล้องกับประเด็นซ้ำ ๆ (เวลาในการรอ บุคลากร สิ่งอำนวยความสะดวก การสื่อสาร และความเอาใจใส่) สัญญาณความเสี่ยงเชิงคาดการณ์อาศัยแบบจำลองลอจิสติกที่รับข้อมูลแนวโน้มต่อเนื่องสามเดือนของแต่ละหน่วยงาน
        </p>
      </section>
    </main>
    <footer>
      อัปเดตอัตโนมัติจาก <code>data/</code> ทุกครั้งที่รัน พร้อมเผยแพร่ผ่าน GitHub Pages
    </footer>

    <script src="https://cdn.plot.ly/plotly-2.35.0.min.js"></script>
    <script>
      const monthNames = [
        'มกราคม',
        'กุมภาพันธ์',
        'มีนาคม',
        'เมษายน',
        'พฤษภาคม',
        'มิถุนายน',
        'กรกฎาคม',
        'สิงหาคม',
        'กันยายน',
        'ตุลาคม',
        'พฤศจิกายน',
        'ธันวาคม'
      ];

      const themeLabels = {
        wait_time: 'เวลารอและการไหลของผู้ป่วย',
        attitude: 'ทัศนคติและความเอาใจใส่ของบุคลากร',
        communication: 'การสื่อสารและคำแนะนำ',
        process: 'กระบวนการและการประสานงาน',
        facilities: 'สิ่งอำนวยความสะดวกและอุปกรณ์',
        staffing: 'ปริมาณบุคลากร'
      };

      const themePalette = ['#38bdf8', '#22d3ee', '#a855f7', '#f97316', '#facc15', '#14b8a6'];

      const timeLabels = {
        morning: 'สัญญาณกะเช้า',
        afternoon: 'สัญญาณช่วงบ่าย',
        evening: 'สัญญาณช่วงเย็น',
        night: 'สัญญาณกะกลางคืน'
      };

      const demographicLabels = {
        elderly: 'ผู้สูงอายุ/ผู้ดูแล',
        children: 'เด็กและครอบครัวกุมารเวช',
        pregnancy: 'การตั้งครรภ์และมารดา',
        caregiver: 'ผู้ดูแลและครอบครัว',
        disability: 'ผู้รับบริการที่มีความพิการ',
        foreign: 'ผู้ป่วยนานาชาติ'
      };

      function formatNumber(value, options = {}) {
        return new Intl.NumberFormat('th-TH', options).format(value);
      }

      function formatScore(score) {
        return score || score === 0 ? score.toFixed(3).replace(/0+$/, '').replace(/\.$/, '') : '—';
      }

      function formatPercent(value) {
        return `${(value * 100).toFixed(1)}%`;
      }

      function formatPeriod(period) {
        const [year, month] = period.split('-').map(Number);
        return `${monthNames[month - 1]} ${year}`;
      }

      function renderMetrics(metadata) {
        const metrics = document.getElementById('metrics');
        metrics.innerHTML = '';
        const cards = [
          {
            label: 'คะแนนความพึงพอใจเฉลี่ยรวม',
            value: formatScore(metadata.overall_average_score)
          },
          {
            label: 'จำนวนหน่วยงานที่ไม่ซ้ำ',
            value: formatNumber(metadata.unique_departments)
          },
          {
            label: 'ระเบียนหน่วยงาน × เดือน',
            value: formatNumber(metadata.department_month_records)
          },
          {
            label: 'แบบสำรวจที่รายงาน',
            value: formatNumber(metadata.total_reported_surveys, { maximumFractionDigits: 0 })
          }
        ];
        for (const card of cards) {
          const div = document.createElement('div');
          div.className = 'metric-card';
          div.innerHTML = `<h4>${card.label}</h4><p>${card.value}</p>`;
          metrics.appendChild(div);
        }

        const coverage = document.getElementById('coverage');
        const first = metadata.periods[0];
        const last = metadata.periods[metadata.periods.length - 1];
        const describe = (period) => {
          const [year, month] = period.split('-').map(Number);
          return `${monthNames[month - 1]} ${year}`;
        };
        coverage.textContent = `รายงานรายเดือนครอบคลุมตั้งแต่ ${describe(first)} ถึง ${describe(last)} (ต่อเนื่อง ${metadata.periods.length} เดือน)`;
      }

      function renderMonthlyTable(summary) {
        const tbody = document.querySelector('#monthly-table tbody');
        tbody.innerHTML = '';
        const periods = summary.metadata.periods;
        for (const period of periods) {
          const view = summary.months[period];
          if (!view) continue;
          const top = view.top10[0];
          const bottom = view.bottom10[0];
          const [year, month] = period.split('-').map(Number);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td data-label="เดือน">${monthNames[month - 1]} ${year}</td>
            <td data-label="หน่วยงานคะแนนสูงสุด">${top ? top.department : '—'}</td>
            <td data-label="คะแนน">${top ? formatScore(top.average_score) : '—'}</td>
            <td data-label="หน่วยงานคะแนนต่ำสุด">${bottom ? bottom.department : '—'}</td>
            <td data-label="คะแนน">${bottom ? formatScore(bottom.average_score) : '—'}</td>
          `;
          tbody.appendChild(tr);
        }
      }

      function renderRanking(viewKey, summary) {
        const ranking = viewKey === 'overall' ? summary.overall : summary.years[viewKey];
        const topBody = document.querySelector('#top-table tbody');
        const bottomBody = document.querySelector('#bottom-table tbody');
        topBody.innerHTML = '';
        bottomBody.innerHTML = '';

        ranking.top10.forEach((row, index) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${index + 1}</td>
            <td>${row.department}</td>
            <td>${formatScore(row.average_score)}</td>
            <td>${row.survey_total ? formatNumber(row.survey_total, { maximumFractionDigits: 0 }) : '—'}</td>
          `;
          topBody.appendChild(tr);
        });

        ranking.bottom10.forEach((row, index) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${index + 1}</td>
            <td>${row.department}</td>
            <td>${formatScore(row.average_score)}</td>
            <td>${row.survey_total ? formatNumber(row.survey_total, { maximumFractionDigits: 0 }) : '—'}</td>
          `;
          bottomBody.appendChild(tr);
        });
      }

      function renderVolatility(insights) {
        const container = document.getElementById('volatility-chart');
        const summary = document.getElementById('volatility-summary');
        if (!window.Plotly) {
          container.textContent = 'ต้องใช้ Plotly เพื่อแสดงดัชนีความผันผวน';
          return;
        }
        const unstable = insights.volatility.most_unstable.slice(0, 10);
        const trace = {
          type: 'bar',
          orientation: 'h',
          x: unstable.map((item) => item.volatility_index),
          y: unstable.map((item) => item.department),
          marker: {
            color: '#f59e0b'
          },
          hovertemplate:
            '<b>%{y}</b><br>ความผันผวน σ: %{x}<br>ช่วงคะแนน: %{customdata[0]}<br>แนวโน้ม/เดือน: %{customdata[1]}<br>จำนวนสังเกต: %{customdata[2]}<extra></extra>',
          customdata: unstable.map((item) => [formatScore(item.score_range), formatScore(item.trend_per_month), item.observations])
        };
        const layout = {
          height: 45 * unstable.length + 80,
          margin: { l: 180, r: 30, t: 10, b: 30 },
          paper_bgcolor: 'rgba(15,23,42,0)',
          plot_bgcolor: 'rgba(15,23,42,0)',
          xaxis: {
            title: 'ความผันผวน (σ)',
            color: '#94a3b8',
            gridcolor: 'rgba(148, 163, 184, 0.25)'
          },
          yaxis: {
            color: '#e2e8f0'
          }
        };
        Plotly.newPlot(container, [trace], layout, { responsive: true, displayModeBar: false });

        summary.innerHTML = '';
        const median = insights.volatility.summary.median_volatility;
        const unstableNames = unstable.slice(0, 3).map((item) => item.department).join(', ');
        const stableNames = insights.volatility.most_stable.slice(0, 3).map((item) => item.department).join(', ');
        const items = [
          `ค่า σ มัธยฐานของ ${insights.volatility.summary.departments_evaluated} หน่วยงาน: <span class="highlight-value">${formatScore(
            median
          )}</span>`,
          `หน่วยงานที่ผันผวนที่สุด: <span class="highlight-value">${unstableNames}</span>`,
          `หน่วยงานที่นิ่งที่สุด: <span class="highlight-value">${stableNames}</span>`
        ];
        for (const text of items) {
          const span = document.createElement('span');
          span.innerHTML = text;
          summary.appendChild(span);
        }
      }

      function renderPerformanceLists(insights) {
        const highList = document.getElementById('high-performance-list');
        const gapList = document.getElementById('critical-gaps-list');
        highList.innerHTML = '';
        gapList.innerHTML = '';

        const makeItem = (record, highlightVolatility = false) => {
          const li = document.createElement('li');
          const title = document.createElement('strong');
          title.textContent = record.department;
          const details = document.createElement('span');
          const parts = [
            `คะแนนเฉลี่ย ${formatScore(record.average_score)}`,
            `แบบสำรวจ ${formatNumber(record.survey_total, { maximumFractionDigits: 0 })}`,
            `จำนวนเดือน ${record.months_observed}`
          ];
          if (highlightVolatility && record.volatility_index != null) {
            parts.push(`σ ${formatScore(record.volatility_index)}`);
          }
          details.textContent = parts.join(' · ');
          li.appendChild(title);
          li.appendChild(details);
          return li;
        };

        insights.high_performance.forEach((record) => {
          highList.appendChild(makeItem(record, true));
        });

        insights.critical_gaps.forEach((record) => {
          const li = document.createElement('li');
          const title = document.createElement('strong');
          title.textContent = record.department;
          const details = document.createElement('span');
          const parts = [
            `คะแนนเฉลี่ย ${formatScore(record.average_score)}`,
            `แบบสำรวจ ${formatNumber(record.survey_total, { maximumFractionDigits: 0 })}`,
            `จำนวนเดือน ${record.months_observed}`
          ];
          if (record.volatility_index != null) {
            parts.push(`σ ${formatScore(record.volatility_index)}`);
          }
          details.textContent = parts.join(' · ');
          li.appendChild(title);
          li.appendChild(details);
          gapList.appendChild(li);
        });
      }

      function renderTrendExplorer(insights) {
        const select = document.getElementById('trend-select');
        const chart = document.getElementById('trend-chart');
        const stats = document.getElementById('trend-stats');
        const monthsPill = document.getElementById('trend-months');
        select.innerHTML = '';
        const departments = insights.trends.departments;
        const map = new Map(departments.map((item) => [item.department, item]));

        const defaultDepartment = departments
          .slice()
          .sort((a, b) => (b.mean_score - a.mean_score !== 0 ? b.mean_score - a.mean_score : b.months_observed - a.months_observed))[0].department;

        for (const item of departments) {
          const option = document.createElement('option');
          option.value = item.department;
          option.textContent = item.department;
          if (item.department === defaultDepartment) {
            option.selected = true;
          }
          select.appendChild(option);
        }

        const render = (department) => {
          const entry = map.get(department);
          if (!entry || !window.Plotly) return;
          const x = entry.series.map((point) => point.period);
          const y = entry.series.map((point) => point.average_score);
          const text = entry.series.map(
            (point) => `${formatPeriod(point.period)}<br>คะแนน ${formatScore(point.average_score)}<br>แบบสำรวจ ${point.survey_count ?? '—'}`
          );
          const trace = {
            x,
            y,
            text,
            type: 'scatter',
            mode: 'lines+markers',
            line: { color: '#38bdf8', width: 3 },
            marker: { color: '#0ea5e9', size: 8 },
            hovertemplate: '%{text}<extra></extra>'
          };
          const layout = {
            margin: { t: 10, r: 20, l: 50, b: 60 },
            yaxis: {
              title: 'คะแนนความพึงพอใจเฉลี่ย',
              range: [3, 5],
              color: '#94a3b8',
              gridcolor: 'rgba(148, 163, 184, 0.25)'
            },
            xaxis: {
              title: 'เดือน',
              color: '#94a3b8'
            },
            paper_bgcolor: 'rgba(15,23,42,0)',
            plot_bgcolor: 'rgba(15,23,42,0)'
          };
          Plotly.newPlot(chart, [trace], layout, { responsive: true, displayModeBar: false });

          monthsPill.textContent = `ติดตาม ${entry.months_observed} เดือน`;
          stats.innerHTML = '';
          const bestPoint = entry.series.reduce((acc, point) => (point.average_score > acc.average_score ? point : acc), entry.series[0]);
          const worstPoint = entry.series.reduce((acc, point) => (point.average_score < acc.average_score ? point : acc), entry.series[0]);
          const statItems = [
            `คะแนนเฉลี่ย <span class="highlight-value">${formatScore(entry.mean_score)}</span>`,
            `เดือนที่ดีที่สุด <span class="highlight-value">${formatPeriod(bestPoint.period)}</span> (${formatScore(bestPoint.average_score)})`,
            `เดือนที่ต่ำที่สุด <span class="highlight-value">${formatPeriod(worstPoint.period)}</span> (${formatScore(worstPoint.average_score)})`
          ];
          for (const textItem of statItems) {
            const span = document.createElement('span');
            span.innerHTML = textItem;
            stats.appendChild(span);
          }
        };

        select.addEventListener('change', () => render(select.value));
        render(defaultDepartment);
      }

      function renderThemes(insights) {
        const container = document.getElementById('theme-chart');
        const legend = document.getElementById('theme-legend');
        if (!window.Plotly) {
          container.textContent = 'ต้องใช้ Plotly เพื่อแสดงไทม์ไลน์ของหัวข้อ';
          return;
        }
        const periods = insights.themes_over_time.map((row) => row.period);
        const traces = Object.keys(themeLabels).map((key, index) => ({
          x: periods,
          y: insights.themes_over_time.map((row) => row.themes[key] || 0),
          type: 'bar',
          name: themeLabels[key],
          marker: { color: themePalette[index % themePalette.length] }
        }));
        const layout = {
          barmode: 'stack',
          margin: { t: 10, r: 20, l: 50, b: 60 },
          paper_bgcolor: 'rgba(15,23,42,0)',
          plot_bgcolor: 'rgba(15,23,42,0)',
          yaxis: {
            title: 'จำนวนการกล่าวถึง',
            color: '#94a3b8',
            gridcolor: 'rgba(148, 163, 184, 0.25)'
          },
          xaxis: {
            title: 'เดือน',
            color: '#94a3b8'
          }
        };
        Plotly.newPlot(container, traces, layout, { responsive: true, displayModeBar: false });

        legend.innerHTML = '';
        Object.entries(themeLabels).forEach(([key, label], index) => {
          const span = document.createElement('span');
          const color = themePalette[index % themePalette.length];
          span.innerHTML = `<span style="width:12px;height:12px;border-radius:3px;background:${color};display:inline-block;"></span>${label}`;
          span.style.color = 'rgba(226, 232, 240, 0.85)';
          span.style.fontWeight = '500';
          span.style.display = 'inline-flex';
          span.style.alignItems = 'center';
          span.style.gap = '0.35rem';
          legend.appendChild(span);
        });

        const topThemes = Object.entries(insights.systemic_themes.themes)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 3)
          .map(([key, count]) => ({
            label: themeLabels[key] || key,
            count
          }));
        const systemicList = document.getElementById('systemic-weaknesses');
        systemicList.innerHTML = '';
        topThemes.forEach((item) => {
          const li = document.createElement('li');
          li.innerHTML = `<strong>${item.label}</strong> — ${formatNumber(item.count)} ครั้ง`;
          systemicList.appendChild(li);
        });

        const sentimentTotals = insights.systemic_themes.sentiment_totals;
        const total = Object.values(sentimentTotals).reduce((acc, value) => acc + value, 0);
        const positiveShare = total ? (sentimentTotals.positive || 0) / total : 0;
        const negativeShare = total ? (sentimentTotals.negative || 0) / total : 0;
        const summary = document.getElementById('sentiment-summary');
        summary.innerHTML = `ข้อเสนอแนะเชิงบวกคิดเป็น <span class="highlight-value">${formatPercent(
          positiveShare
        )}</span> ขณะที่ข้อร้องเรียนหรือคำขอปรับปรุงคิดเป็น <span class="highlight-value">${formatPercent(negativeShare)}</span> จากความคิดเห็นที่จัดหมวดหมู่ทั้งหมด ${formatNumber(
          total
        )} รายการ`;

        const timeBody = document.getElementById('time-table');
        timeBody.innerHTML = '';
        insights.systemic_themes.time_of_day.forEach((row) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${timeLabels[row.time] || row.time}</td>
            <td>${formatNumber(row.mentions)}</td>
            <td>${formatPercent(row.share)}</td>
          `;
          timeBody.appendChild(tr);
        });

        const demographicBody = document.getElementById('demographic-mentions');
        demographicBody.innerHTML = '';
        insights.systemic_themes.demographic_mentions.forEach((row) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${demographicLabels[row.group] || row.group}</td>
            <td>${formatNumber(row.mentions)}</td>
          `;
          demographicBody.appendChild(tr);
        });
      }

      function renderWaitCorrelation(insights) {
        const container = document.getElementById('wait-correlation-chart');
        const note = document.getElementById('wait-correlation-note');
        if (!window.Plotly) {
          container.textContent = 'ต้องใช้ Plotly เพื่อแสดงความสัมพันธ์';
          return;
        }
        const series = insights.wait_time_correlation.series;
        const trace = {
          x: series.map((row) => row.wait_share * 100),
          y: series.map((row) => row.satisfaction),
          mode: 'markers+text',
          text: series.map((row) => row.period),
          textposition: 'top center',
          marker: {
            color: '#38bdf8',
            size: 10
          },
          hovertemplate: 'เดือน %{text}<br>การกล่าวถึงเรื่องรอ %{customdata[0]} / %{customdata[1]}<br>สัดส่วนการกล่าวถึง %{x:.1f}%<br>คะแนนเฉลี่ย %{y:.3f}<extra></extra>',
          customdata: series.map((row) => [row.wait_mentions, row.comment_total])
        };
        const layout = {
          margin: { t: 10, r: 20, l: 60, b: 60 },
          xaxis: {
            title: 'การกล่าวถึงเวลารอ (% ของความคิดเห็น)',
            color: '#94a3b8',
            gridcolor: 'rgba(148, 163, 184, 0.25)'
          },
          yaxis: {
            title: 'คะแนนความพึงพอใจเฉลี่ย',
            color: '#94a3b8',
            range: [3.5, 5]
          },
          paper_bgcolor: 'rgba(15,23,42,0)',
          plot_bgcolor: 'rgba(15,23,42,0)'
        };
        Plotly.newPlot(container, [trace], layout, { responsive: true, displayModeBar: false });

        const r = insights.wait_time_correlation.pearson_r;
        const p = insights.wait_time_correlation.p_value;
        note.innerHTML = `ค่าสหสัมพันธ์ r = <span class="highlight-value">${r !== null ? r.toFixed(2) : 'ไม่ระบุ'}</span>, p-value = <span class="highlight-value">${
          p !== null ? p.toFixed(3) : 'ไม่ระบุ'
        }</span> การร้องเรียนเรื่องเวลารอที่สูงขึ้นสัมพันธ์กับความพึงพอใจที่ลดลงในหลายเดือน`;
      }

      function renderBenchmarking(insights) {
        const list = document.getElementById('benchmarking-list');
        list.innerHTML = '';
        const topStats = insights.benchmarking.top10.stats;
        const bottomStats = insights.benchmarking.bottom10.stats;
        const delta = insights.benchmarking.delta;
        const items = [
          `ค่าเฉลี่ยคะแนนของกลุ่ม 10 อันดับแรก <span class="highlight-value">${formatScore(topStats.mean_score)}</span> เทียบกับกลุ่มท้ายสุด <span class="highlight-value">${formatScore(
            bottomStats.mean_score
          )}</span> (ช่องว่าง ${formatScore(delta.score_gap)})`,
          `กลุ่มบนจัดการแบบสำรวจราว <span class="highlight-value">${formatNumber(Math.round(topStats.mean_survey_total))}</span> ฉบับต่อเดือน เทียบกับ <span class="highlight-value">${formatNumber(
            Math.round(bottomStats.mean_survey_total)
          )}</span> ในกลุ่มล่าง`,
          `ความผันผวนเฉลี่ยของกลุ่มบนอยู่ที่ ${topStats.mean_volatility != null ? formatScore(topStats.mean_volatility) : '—'} เมื่อเทียบกับ ${
            bottomStats.mean_volatility != null ? formatScore(bottomStats.mean_volatility) : '—'
          } ของกลุ่มล่าง`
        ];
        items.forEach((text) => {
          const li = document.createElement('li');
          li.innerHTML = text;
          list.appendChild(li);
        });
      }

      function renderPredictiveRisk(insights) {
        const tbody = document.querySelector('#risk-table tbody');
        tbody.innerHTML = '';
        const nextPeriod = insights.predictive_risk.next_period;
        if (nextPeriod) {
          document.querySelector('#predictive-risk h2').innerHTML = `มุมมองความเสี่ยงเชิงคาดการณ์ <span class="pill">ช่วงถัดไป ${nextPeriod}</span>`;
        }
        insights.predictive_risk.high_risk_departments.slice(0, 15).forEach((row) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row.department}</td>
            <td>${formatPercent(row.probability_of_decline)}</td>
            <td>${row.last_period}</td>
            <td>${formatScore(row.last_score)}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      function renderDemographicTables(insights) {
        const serviceBody = document.querySelector('#service-group-table tbody');
        serviceBody.innerHTML = '';
        insights.demographic_disparity.service_groups.forEach((row) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row.service_group}</td>
            <td>${formatScore(row.average_score)}</td>
            <td>${formatNumber(row.survey_total)}</td>
            <td>${formatNumber(row.departments)}</td>
          `;
          serviceBody.appendChild(tr);
        });

        const demoBody = document.querySelector('#demographic-table tbody');
        demoBody.innerHTML = '';
        insights.demographic_disparity.comment_mentions.forEach((row) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${demographicLabels[row.group] || row.group}</td>
            <td>${formatNumber(row.mentions)}</td>
          `;
          demoBody.appendChild(tr);
        });
      }

      async function init() {
        const [summaryResponse, insightsResponse] = await Promise.all([
          fetch('data/summary.json'),
          fetch('data/advanced_insights.json')
        ]);
        const summary = await summaryResponse.json();
        const insights = await insightsResponse.json();

        renderMetrics(summary.metadata);
        renderMonthlyTable(summary);
        renderRanking('overall', summary);

        const buttons = document.querySelectorAll('.tab-strip button');
        buttons.forEach((button) => {
          button.addEventListener('click', () => {
            buttons.forEach((btn) => btn.classList.toggle('active', btn === button));
            renderRanking(button.dataset.key, summary);
          });
        });

        renderVolatility(insights);
        renderPerformanceLists(insights);
        renderTrendExplorer(insights);
        renderThemes(insights);
        renderWaitCorrelation(insights);
        renderBenchmarking(insights);
        renderPredictiveRisk(insights);
        renderDemographicTables(insights);
      }

      init().catch((error) => {
        console.error('โหลดข้อมูลแดชบอร์ดไม่สำเร็จ', error);
      });
    </script>
  </body>
</html>
